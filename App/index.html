<!DOCTYPE html>
<html>
	<head>

		<meta name="keywords" content="WebRTC, HTML5, JavaScript" />
		<meta name="description" content="WebRTC Reference App" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

		<title>WebRTC client</title>

	</head>

	<body>


		<script src="/socket.io/socket.io.js"></script>

		<div id = 'videos'>
		</div>


		<script>
			// Init socket
			var socket = io();
			
			// Keep track of users
			var localUser = {id : "", mediaStream : null};

			// Init getUserMedia
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

			var constraints = {video: true, audio: false};

			// Send video function
			function gotMedia(localMediaStream)
			{
				localUser.mediaStream = localMediaStream;
				socket.emit('localMedia', localUser.mediaStream);
			}
			
			// Error function
			function gotError(error)
			{
				console.log("getUserMedia error : ", error);
			}

			

			// Upon receiving media, play it
			socket.on('remoteMedia', function(users){
									//var div = document.getElementById('videos');
									for(index = 0; index < users.length; index ++)
									{
										var vid = document.getElementById('video' + users[index].id);
										window.stream = users[index].mediaStream;
										//document.write(window.URL.createObjectURL(users[index].mediaStream));
										vid.src = window.URL.createObjectURL(users[index].mediaStream);
										vid.play();
									}
					   			      });
			// User updates
			socket.on('someoneLeft', function(users){
									// Find the div
									var place = document.getElementById('videos');
									// Query videos
									var vids = place.childNodes;
						
									// Delete inactive video elements
									for(index = 1; index <= vids.length; index ++)
									{
										// Check against active user ids
										var vidFound = false;
										for(uIndex = 0; uIndex < users.length; uIndex ++)
										{
											if(vids[index].id == users[index].id)
												vidFound = true;
										}
										// Remove video element
										if(!vidFound)
											place.removeChild(vids[index]);
									}
								      });
			
			socket.on('newUser', function(newNumUsers){
							// Find the div
							var place = document.getElementById('videos');
							// Create a new video element
							var v = document.createElement('video');
							v.autoPlay = true;
							v.src = "";
							v.id = 'video' + newNumUsers;
							// Add video to the div
							place.appendChild(v);
						       });
			// Begin the process
			navigator.getUserMedia(constraints, gotMedia, gotError);
		</script>

	</body>
</html>
