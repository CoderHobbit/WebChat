<!DOCTYPE html>
<html>
	<head>

		<meta name="keywords" content="WebRTC, HTML5, JavaScript" />
		<meta name="description" content="WebRTC Reference App" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

		<title>WebRTC client</title>

	</head>

	<body>


		<script src="/socket.io/socket.io.js"></script>

		<div id = 'videos'>
		</div>


		<script>
			// Init socket
			var socket = io();
			
			// Keep track of users
			var localUser = {id : "", mediaStream : ""};

			// Init getUserMedia
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
			// Init peerConnection
			var peerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
			// Init sessionDescription
			var sessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;
			

			// This function will display an incoming stream
			pc.onaddstream = function(obj)
			{
				// Create a video element
				var vid = document.createElement("video");
				// Add to the document				
				document.appendChild(vid);
				// Stream media through the video element				
				vid.srcObject = obj.stream;
				// Play the video
				vid.play();
			}
			
			// Initialize some config variables
			var config = {"iceServers":[{"url":"stun:stun.l.google.com:19302"}]};
			var connection = { 'optional': [{'DtlsSrtpKeyAgreement': true}, {'RtpDataChannels': true }] };
			
			// Create a peer connection
			peerConnection = new webkitRTCPeerConnection(config, connection);
			peerConnection.onicecandidate = function(e)
							{
								if (!peerConnection || !e || !e.candidate) 
									return;
								var candidate = event.candidate;
								sendNegotiation("candidate", candidate);
							}
			// Open data channel
			dataChannel = peerConnection.createDataChannel("datachannel", {reliable: false});
			
			// Message callback - displays received video
			dataChannel.onmessage = function(e)
						{
							console.log("DC from ["+user2+"]:" +e.data);
						}
			// Data channel opened callback
			dataChannel.onopen = function()
			{
					console.log("------ DATACHANNEL OPENED ------");
					$("#sendform").show();
			};
		
			// Data channel closed callback	
			dataChannel.onclose = function()
					      {
					      	      console.log("------ DC closed! ------");
					      };
			// Data channel error callback
			dataChannel.onerror = function()
					      {
						      console.log("DC ERROR!!!");
					      };
			// Data channel callback
			peerConnection.ondatachannel = function() 
							{
								console.log('peerConnection.ondatachannel event fired.');
							};
			
			// Set remote description
			peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

			var sdpConstraints = {'mandatory':
							{
								'OfferToReceiveAudio': true,
								'OfferToReceiveVideo': true
							}
					     };
			// Create and send answer sdp
			peerConnection.createAnswer(function(sdp) 
						    {
			  				peerConnection.setLocalDescription(sdp);
			  				sendNegotiation("answer", sdp);
			  				console.log("------ SEND ANSWER ------");
						    }, null, sdpConstraints);
			// Proccess ice candidates
			function processIce(iceCandidate){
  				peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));
			}

			// Helper functions
			function end()
			{
				// Find all the videos
				var vids = document.getElementsByTagName("video");
				// Loop through and pause each video
				for(index = 0; index < vids.length; i++)
					vids[index].pause();
				// Terminate the connection
				pc.close();
			}
			function error(e)
			{
				// Log the error
				console.log(e);
				// Lolnope
				end();
			}
		
			// Prepare constraints
			var constraints = {video: true, audio: true};

			// Send video function
			function gotMedia(stream)
			{
				// Add the stream
				pc.onaddstream({stream : stream});
				pc.addsStream(stream);
				
				// Create and send an offer
				pc.createOffer(function(offer){
							pc.setLocalDescription(new sessionDescription(offer), function(){
								// Send offer
							}, error);
						}, error);
			});
			
			// Error function
			function gotError(error)
			{
				console.log("getUserMedia error : ", error);
			}

			

			// Upon receiving media, play it
			socket.on('remoteMedia', function(users)
						{
							// Cycle through all the users
							for(index = 0; index < users.length; index ++)
							{
								// Index a user
								var user = users[index];
								// Find respective video element
								var vid = document.getElementById(/*'video' + */user.id);	
								// Attach media to video element
								vid.src = /*window.URL.createObjectURL(*/user.mediaStream/*)*/;
								// Play the video
								vid.play();
							}
					   	});
			// User updates
			socket.on('someoneLeft', function(users)
						{
							// Find the div
							var place = document.getElementById('videos');
							// Query videos
							var vids = place.childNodes;
			
							// Delete inactive video elements
							for(index = 1; index <= vids.length; index ++)
							{
								// Check against active user ids
								var vidFound = false;
								for(uIndex = 0; uIndex < users.length; uIndex ++)
								{
									if(vids[index].id == users[index].id)
										vidFound = true;
								}
								// Remove video element
								if(!vidFound)
									place.removeChild(vids[index]);
							}
						});
			
			socket.on('newUser', function(newNumUsers)
						{
							// Find the div
							var place = document.getElementById('videos');
							// Create a new video element
							var v = document.createElement('video');
							v.autoPlay = true;
							v.src = "";
							v.id = 'video' + newNumUsers;
							// Update localUser id
							localUser.id = v.id;
							// Add video to the div
							place.appendChild(v);
							
						});
			// Begin the process
			navigator.getUserMedia(constraints, gotMedia, gotError);
	
			
			
		</script>

	</body>
</html>
