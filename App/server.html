<!DOCTYPE html>
<html>
	<head>

		<meta name="keywords" content="WebRTC, HTML5, JavaScript" />
		<meta name="description" content="WebRTC Reference App" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">

		<title>WebChat Server</title>

	</head>

	<body>

		<div id = 'allVideos'>
		</div>

		<script src="/socket.io/socket.io.js"></script>

		<script>
			// Initialize socket.io
			var socket = io();
			// Initialize organization variables
			var connections = [];
			// Temp var to store a peerconnection
			var pc = null;
			// Number of videos
			var numVids = 0;
			// Constraint variable for controlling order of events
			var gotSdp = false;

			// Init peerConnection
			var RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
			// Init sessionDescription
			var RTCessionDescription = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;
		
			// Initialize some config variables
			var connection = {'iceServers':[{'url':'stun:stun.l.google.com:19302'}, {'url': 'turn:homeo@turn.bistri.com:80', 'credential': 'homeo'}]};
			var config = { 'optional': [{'DtlsSrtpKeyAgreement': true}, {'RtpDataChannels': true }]};
			var sdpConstraints = {'mandatory': {
 											'OfferToReceiveAudio':true,
  											'OfferToReceiveVideo':true }};

			// Server message callbacks
			socket.on('newUser', 
							function(peepl)
							{
								// First user is us!
								if(peepl == 1)
								{
									console.log("I'm connected!");
								}
								// Peer connections are about to happen
								else
								{
									// Reset constraint variable
									gotSdp = false;
									// Begin peerconnection process
									start();
								}
							});
			socket.on('someoneLeft',
							function()
							{
								// Do something about it
							});
			// Signaling handler
			socket.on('message', gotMessageFromServer);

			// Start function - creates a peerConnection			
			function start(isCaller) 
			{
				console.log('I have started!');
				// Create a new connection
				peerConnection = new RTCPeerConnection(connection, config);
				// Set callbacks
				peerConnection.onaddstream = gotRemoteStream;
				// Set as active connection
				pc = peerConnection;
				// Add to connections
				connections.push(peerConnection);
			}
	
			// Offer handler
			function gotDescription(description) 
			{
				console.log('Set local SDP!');
				// Set local description and send it back
				pc.setLocalDescription(description, 
											function () 
											{
												socket.send(JSON.stringify({sdp:description}));
											}, errorHandler);
			}

			// ICE candidate handler
			function gotIceCandidate(event) 
			{
				console.log('Got ICE candidate!');
				// Separate candidate and send it to the clients
				var candidate = event.candidate;
				if(event.candidate != null) 
				{
				  socket.send(JSON.stringify({candidate: candidate}));
				}
			}

			// Broadcast handler
			function gotMessageFromServer(m) 
			{
				// Parse the message
				var signal = JSON.parse(m);
				// Check if the message is an offer
				if(signal.sdp) 
				{
					console.log('Got remote SDP!');
					// Set remote description
					pc.setRemoteDescription(new RTCSessionDescription(signal.sdp), 
													function() 
													{
														console.log('Creating answer!');
														// Create answer
														pc.createAnswer(gotDescription, errorHandler, sdpConstraints);
														// We are ready to gather ice candidates now
														peerConnection.onicecandidate = gotIceCandidate;
													}, errorHandler);
				}
				// Check if the message is an ICE candidate
				else if(signal.candidate && gotSdp) 
				{
					// Create a candidate from the given information
					var candidate = new RTCIceCandidate(signal.candidate, signal.sdpMLineIndex);
					// Add candidate
					peerConnection.addIceCandidate(candidate, function()
																			{
																				console.log('Successfully added ICE candidate!');
																			}, errorHandler);
					console.log('Created and added ICE candidate!');
				}
			}
			
			// Remote stream handler
			function gotRemoteStream(event) 
			{
				console.log('Got remote stream: ', event.stream);
				// Increase current number of videos
				numVids ++;
				// Find the video div
				var theDiv = document.getElementById('allVideos');
				// Create a new video
				var v = document.createElement('video');
				v.id = numVids;
				v.src = window.URL.createObjectURL(event.stream);
				v.play();
				// Add video to the div
				theDiv.appendChild(v);
				// Send URLs for all videos to everyone
				sendUrls();
			}

			// Broadcasts URLs of all video elements to all connected peers
			function sendUrls()
			{
				// Grab the div, and all of its child nodes
				var vids = document.getElementById('allVideos').childNodes;
				// Cycle through the vids, sending the URL of each out
				for(var i = 0; i < vids.length; i ++)
				{
					socket.emit('newVideo', vids[i].url);
				}
			}

			// Error handler
			function errorHandler(error) 
			{
				// Log the error
				console.log(error);
			}

		</script>
	</body>
</html>
